---
title: "Hive Parameter Analysis"
output: html_notebook
---

```{r Load Packages}
library(tidyverse)
library(ggplot2)
library(readr)
library(viridis)
library(ggfortify)


round_any <- function(x, accuracy, f=round){f(x/ accuracy) * accuracy}

```

```{r Read in Data}

bee_param_df <- list.files(path="hive_data/heat_queen/", full.names = TRUE) %>% 
                lapply(read_csv, show_col_types = FALSE) %>% 
                bind_rows

write.csv(bee_param_df,"bee_data_isaac_heat_queen.csv",row.names = FALSE)

```

What these all mean:
n = queen cells per hour
rb = brood radius
rn = necter radius
w = total daily honey
pph = pollen ratio
ph = honey consumption ratio
pp = pollen consumption ratio
k = consumption probability value

broodMetric = average number of brood surrounding other brood
pollenRing = average min distance between honey and brood

```{r}
brood_bee_param <- read.csv("bee_data_isaac_heat_brood.csv") %>% mutate(type = "Brood") #%>% mutate(wha = 0, qha = 0)
worker_bee_param <- read.csv("bee_data_isaac_heat_worker.csv") %>% mutate(type = "Worker") #%>% mutate(bhd = 0, qha = 0)
queen_bee_param <- read.csv("bee_data_isaac_heat_queen.csv") %>% mutate(type = "Queen") #%>% mutate(bhd = 0, wha = 0)
none_bee_param <- read.csv("bee_data_isaac_heat_none.csv") %>% mutate(type = "None") #%>% mutate(bhd = 0,wha = 0, qha = 0)

bee_heat_param_df <- rbind(brood_bee_param,worker_bee_param) %>% rbind(.,queen_bee_param) %>% rbind(.,none_bee_param)
```


```{r}
ggplot(bee_heat_param_df, aes(x = type, y = pBroodHeat))+
  geom_boxplot()+
  theme_classic()

heat_glm <- glm(pBroodHeat ~ 0 + type, data = bee_heat_param_df)
heat_glm
```
Looking at correlation between heat parameter and brood in the place

```{r}
worker_bee_param <- read.csv("bee_data_isaac_heat_worker.csv") %>% mutate(type = "Worker")


ggplot(worker_bee_param, aes(x = wha, y = pBroodHeat))+
  geom_point()+
  geom_smooth(method = 'glm', formula = 'y ~ x')+
  theme_classic()

cor.test(worker_bee_param$wha,worker_bee_param$pBroodHeat)


queen_bee_param <- read.csv("bee_data_isaac_heat_queen.csv") %>% mutate(type = "Queen")

ggplot(queen_bee_param, aes(x = qha/5, y = pBroodHeat))+
  geom_point()+
  geom_smooth(method = 'glm', formula = 'y ~ x')+
  theme_classic()

cor.test(queen_bee_param$qha,queen_bee_param$pBroodHeat)


```





```{r}
rand_bee_param <- read.csv("bee_data_isaac_rand.csv") %>% mutate(type = "Rand")
m1_bee_param <- read.csv("bee_data_isaac_m1.csv") %>% mutate(type = "M1") %>% select(-trial_n)
m2_bee_param <- read.csv("bee_data_isaac_m2.csv") %>% mutate(type = "M2") %>% select(-trial_n)
m2E_bee_param <- read.csv("bee_data_isaac_m2_empty.csv") %>% mutate(type = "M2E") %>% select(-trial_n)
m2K_bee_param <- read.csv("bee_data_isaac_m2_katie.csv") %>% mutate(type = "M2K") %>% select(-trial_n)

bee_param_df <- rbind(m1_bee_param,m2_bee_param) %>% rbind(.,rand_bee_param) %>% rbind(.,m2E_bee_param) %>% rbind(.,m2K_bee_param)
```


```{r}
bee_param_df_perc <- bee_param_df %>% select(c(type,pBrood,pHoney,pPollen,pEmpty)) %>%
                                      pivot_longer(c(pBrood,pHoney,pPollen,pEmpty))
```


```{r Overall Brood and Pollen}

ggplot(bee_param_df, aes(x = broodMetric, y = pollenRing, color = type))+
  geom_point(alpha = 0.25)+
  ylim(0,16)+
  xlim(0,6)+
  theme_classic()

ggplot(bee_param_df_perc, aes(x = type, y = value, fill = name))+
  geom_boxplot()+
  theme_classic()

ggplot(m1_bee_param, aes(x = pPollen, y = pph))+
  geom_point()+
  theme_classic()

```

```{r Brood Metric GLMs}
broodMetricGLM_m0 <- glm(broodMetric ~ 1, data = m2_bee_param)
broodMetricGLM_m1 <- glm(broodMetric ~ n + rb + rn + w + pph + ph + pp + k, data = m2_bee_param)
broodMetricGLM_step <- step(broodMetricGLM_m0, direction = "both", scope = formula(broodMetricGLM_m1), trace = 0)

summary(broodMetricGLM_step)
```

```{r Pollen Ring GLMs}
pollenRingGLM_m0 <- glm(pollenRing ~ 1, data = m2_bee_param)
pollenRingGLM_m1 <- glm(pollenRing ~ n + rb + rn + w + pph + ph + pp + k, data = m2_bee_param)
pollenRingGLM_step <- step(pollenRingGLM_m0, direction = "both", scope = formula(pollenRingGLM_m1), trace = 0)

summary(pollenRingGLM_step)
```

```{r}
queen_pos_df <- read.csv("queen_pos_data_0_5.csv")

queen_pos_df_heatmap <- queen_pos_df %>% mutate(QueenXRound = round_any(QueenX,5),
                                                QueenYRound = round_any(QueenY,5)) %>%
                                        group_by(QueenXRound,QueenYRound) %>%
                                        summarise(meanAngleMoved = mean(AngleMoved),
                                                  count = n())

```


```{r}
ggplot(queen_pos_df, aes(x = QueenX, y = QueenY))+
  geom_path()+
  geom_point(aes(x=11,y=48.5),colour="red") +
  scale_color_viridis() +
  theme_classic()

ggplot(queen_pos_df, aes(x = QueenX, y = QueenY, color = Dist2Heat))+
  geom_point()+
  geom_point(aes(x=11,y=48.5),colour="red") +
  scale_color_viridis() +
  theme_classic()

ggplot(queen_pos_df, aes(x = QueenX, y = QueenY, color = cos(AngleOppHeat)))+
  geom_point()+
  geom_point(aes(x=11,y=48.5),colour="red") +
  scale_color_viridis() +
  theme_classic()

ggplot(queen_pos_df, aes(x = QueenX, y = QueenY, color = sin(AngleOppHeat)))+
  geom_point()+
  geom_point(aes(x=11,y=48.5),colour="red") +
  scale_color_viridis() +
  theme_classic()

ggplot(queen_pos_df_heatmap, aes(x = QueenXRound, y = QueenYRound, color = cos(meanAngleMoved)))+
  geom_point(size = 5)+
  geom_point(aes(x=11,y=48.5),colour="red") +
  scale_color_viridis() +
  theme_classic()

ggplot(queen_pos_df_heatmap, aes(x = QueenXRound, y = QueenYRound, color = sin(meanAngleMoved)))+
  geom_point(size = 5)+
  geom_point(aes(x=11,y=48.5),colour="red") +
  scale_color_viridis() +
  theme_classic()

ggplot(queen_pos_df_heatmap, aes(x = QueenXRound, y = QueenYRound, color = count))+
  geom_point(size = 5)+
  geom_point(aes(x=11,y=48.5),colour="red") +
  scale_color_viridis() +
  theme_classic()
```


```{r}

hive_pca <- prcomp(bee_heat_param_df %>% select(-c(...1, trial_n, type, days, n,
                                                   pBrood, pPollen, pHoney, pEmpty,
                                                   pBroodHeat, pPollenHeat, pHoneyHeat, pEmptyHeat,
                                                   broodMetric,pollenRing)),
                   center = TRUE,scale. = TRUE)
summary(hive_pca)


autoplot(hive_pca, colour = "pHoney", loadings = TRUE, loadings.label = TRUE,
         data = bee_heat_param_df)+
  scale_color_viridis()+
  theme_classic()

ggplot(bee_heat_param_df, aes(pPollenHeat, pBroodHeat))+
  geom_point()+
  theme_classic()

ggplot(bee_heat_param_df, aes(wha, pPollen))+
  geom_point()+
  theme_classic()
```

